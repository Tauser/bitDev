<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"
    />
    <title>BitDev Monitor</title>
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="logo"><i class="fa-brands fa-bitcoin"></i> BitDev</div>
        <div class="header-actions">
          <a
            href="#"
            class="btn-icon danger"
            onclick="confirmShutdown('/desligar')"
            title="Desligar"
            ><i class="fa-solid fa-power-off"></i
          ></a>
          <a
            href="#"
            class="btn-icon warning"
            onclick="confirmAction('/reiniciar', 'Reiniciar o painel?')"
            title="Reiniciar"
            ><i class="fa-solid fa-rotate-right"></i
          ></a>
          <a href="/alternar_noturno" class="btn-icon" title="Modo Noturno">
            {% if noturno %}
            <i class="fa-solid fa-sun"></i>
            {% else %}
            <i class="fa-solid fa-moon"></i>
            {% endif %}
          </a>
        </div>
      </header>

      <div id="toast-container"></div>

      <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'Dashboard')">
          <i class="fa-solid fa-chart-line"></i> Dash
        </button>
        <button class="tab-btn" onclick="openTab(event, 'Config')">
          <i class="fa-solid fa-gear"></i> Config
        </button>
        <button class="tab-btn" onclick="openTab(event, 'Galeria')">
          <i class="fa-solid fa-image"></i> Galeria
        </button>
        <button class="tab-btn" onclick="openTab(event, 'Sistema')">
          <i class="fa-solid fa-server"></i> Sistema
        </button>
      </div>

      <!-- DASHBOARD TAB -->
      <div id="Dashboard" class="tab-content active" style="display: flex">
        <div class="card">
          <h3>Brilho da Tela - {{ brilho }}%</h3>
          <form onsubmit="submitForm(event, '/brilho')" class="range-form">
            <input
              type="range"
              name="nivel"
              min="10"
              max="100"
              step="10"
              value="{{ brilho }}"
              list="brilho-markers"
              onchange="submitForm(null, '/brilho', this.form)"
            />
            <datalist id="brilho-markers">
              <option value="10" label="10%"></option>
              <option value="20" label="20%"></option>
              <option value="30" label="30%"></option>
              <option value="40" label="40%"></option>
              <option value="50" label="50%"></option>
              <option value="60" label="60%"></option>
              <option value="70" label="70%"></option>
              <option value="80" label="80%"></option>
              <option value="90" label="90%"></option>
              <option value="100" label="100%"></option>
            </datalist>
          </form>
        </div>

        <div class="card">
          <h3>Moedas Monitoradas</h3>
          <div id="coin-list" class="chip-container">
            {% for moeda in moedas %}
            <div class="chip" data-symbol="{{ moeda }}">
              <!-- {{ moeda.replace('USDT','') }} -->
              {{ moeda}}
              <span
                onclick="removeCoin('{{ moeda }}')"
                class="remove-btn"
                style="cursor: pointer"
                >&times;</span
              >
            </div>
            {% endfor %}
          </div>
          <form
            onsubmit="submitForm(event, '/adicionar', null, true)"
            class="add-form"
          >
            <input
              type="text"
              name="simbolo"
              placeholder="Ex: BTC, ETH, PEPE"
              required
            />
            <button type="submit"><i class="fa-solid fa-plus"></i></button>
          </form>
        </div>
      </div>

      <!-- CONFIG TAB -->
      <div id="Config" class="tab-content">
        <div class="card">
          <h3>Playlist de Telas</h3>
          <form onsubmit="savePlaylist(event)">
            <div class="playlist-list" id="playlist-list">
              {% for page in pages %}
              <div class="playlist-item" data-id="{{ page.id }}">
                <i
                  class="fa-solid fa-bars handle"
                  style="color: #64748b; cursor: grab; margin-right: 10px"
                ></i>
                <label class="switch">
                  <input
                    type="checkbox"
                    name="enable_{{ page.id }}"
                    {%
                    if
                    page.enabled
                    %}checked{%
                    endif
                    %}
                  />
                  <span class="slider round"></span>
                </label>
                <span class="page-name">{{ page.nome }}</span>
                <input
                  type="number"
                  name="time_{{ page.id }}"
                  value="{{ page.tempo }}"
                  min="5"
                  max="300"
                  class="time-input"
                />
                s
              </div>
              {% endfor %}
            </div>
            <button type="submit" class="btn btn-primary full-width">
              Salvar Playlist
            </button>
          </form>
        </div>

        <div class="card">
          <h3>Meteorologia</h3>
          <form onsubmit="submitForm(event, '/salvar_clima')">
            <div class="form-group">
              <label style="margin-bottom: 5px; display: block">Cidade</label>
              <div style="display: flex; gap: 8px">
                <input
                  type="text"
                  name="cidade"
                  value="{{ cidade }}"
                  placeholder="Ex: Sao Paulo, New York"
                  list="cities-list"
                  required
                />
                <button
                  type="button"
                  id="btn-location"
                  class="btn btn-secondary"
                  onclick="getCurrentLocation()"
                  title="Usar localização atual"
                >
                  <i class="fa-solid fa-location-crosshairs"></i>
                </button>
              </div>
              <datalist id="cities-list">
                <option value="Sao Paulo">Brasil</option>
                <option value="Rio de Janeiro">Brasil</option>
                <option value="Belo Horizonte">Brasil</option>
                <option value="Brasilia">Brasil</option>
                <option value="Curitiba">Brasil</option>
                <option value="Salvador">Brasil</option>
                <option value="Fortaleza">Brasil</option>
                <option value="Manaus">Brasil</option>
                <option value="Recife">Brasil</option>
                <option value="Porto Alegre">Brasil</option>
                <option value="Florianopolis">Brasil</option>
                <option value="New York">USA</option>
                <option value="London">UK</option>
                <option value="Tokyo">Japan</option>
                <option value="Paris">France</option>
                <option value="Berlin">Germany</option>
                <option value="Lisbon">Portugal</option>
                <option value="Madrid">Spain</option>
                <option value="Rome">Italy</option>
              </datalist>
            </div>
            <div class="form-group">
              <label
                style="
                  margin-bottom: 5px;
                  display: block;
                  font-size: 0.9rem;
                  color: #94a3b8;
                "
                >Coordenadas (Opcional - Substitui Cidade)</label
              >
              <div style="display: flex; gap: 10px">
                <input
                  type="text"
                  name="latitude"
                  value="{{ lat }}"
                  placeholder="Lat (ex: -23.55)"
                  style="width: 50%"
                />
                <input
                  type="text"
                  name="longitude"
                  value="{{ lon }}"
                  placeholder="Lon (ex: -46.63)"
                  style="width: 50%"
                />
              </div>
            </div>
            <button type="submit" class="btn btn-primary full-width">
              Salvar Cidade
            </button>
          </form>
        </div>

        <div class="card">
          <h3>Impressora 3D (Klipper)</h3>
          <form onsubmit="submitForm(event, '/salvar_printer')">
            <div class="form-group">
              <label style="margin-bottom: 5px; display: block"
                >IP da Impressora</label
              >
              <input
                type="text"
                name="printer_ip"
                value="{{ printer_ip }}"
                placeholder="192.168.x.x"
              />
            </div>
            <div class="form-group">
              <label style="margin-bottom: 5px; display: block"
                >Nome de Exibição</label
              >
              <input
                type="text"
                name="printer_name"
                value="{{ printer_name }}"
                placeholder="VORON 2.4"
              />
            </div>
            <button type="submit" class="btn btn-primary full-width">
              Salvar Impressora
            </button>
          </form>
        </div>

        <div class="card">
          <h3>Configurar Wi-Fi</h3>
          <form onsubmit="submitForm(event, '/salvar_wifi')">
            <div class="form-group">
              <label style="margin-bottom: 5px; display: block"
                >SSID (Nome da Rede)</label
              >
              <input
                type="text"
                name="ssid"
                placeholder="Nome do Wi-Fi"
                required
              />
            </div>
            <div class="form-group">
              <label style="margin-bottom: 5px; display: block">Senha</label>
              <div style="position: relative">
                <input
                  type="password"
                  id="wifi-psk"
                  name="psk"
                  placeholder="Senha do Wi-Fi"
                  required
                  style="padding-right: 40px"
                />
                <i
                  class="fa-solid fa-eye"
                  id="toggle-psk-btn"
                  onclick="toggleWifiPassword()"
                  style="
                    position: absolute;
                    right: 10px;
                    top: 50%;
                    transform: translateY(-50%);
                    cursor: pointer;
                    color: #94a3b8;
                  "
                ></i>
              </div>
            </div>
            <button type="submit" class="btn btn-warning full-width">
              Salvar e Conectar
            </button>
          </form>
        </div>
      </div>

      <!-- GALERIA TAB -->
      <div id="Galeria" class="tab-content">
        <div class="card">
          <h3>Upload de GIF</h3>
          <form
            onsubmit="uploadGif(event)"
            enctype="multipart/form-data"
            class="upload-form"
          >
            <input type="file" name="file" accept=".gif" required />
            <button type="submit" class="btn btn-primary">Enviar</button>
          </form>

          <div
            id="upload-progress-container"
            style="display: none; margin-top: 15px"
          >
            <div class="progress-bar">
              <div
                id="upload-progress-fill"
                class="progress-fill system"
                style="width: 0%"
              ></div>
            </div>
            <div
              style="
                text-align: center;
                font-size: 0.8rem;
                margin-top: 5px;
                color: #94a3b8;
              "
              id="upload-progress-text"
            >
              0%
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Buscar no Tenor</h3>
          <div class="search-box">
            <input
              type="text"
              id="tenor-query"
              placeholder="Ex: Mario, Bitcoin, Cat"
              onkeypress="handleEnter(event)"
            />
            <button onclick="searchTenor()">
              <i class="fa-solid fa-search"></i>
            </button>
          </div>
          <div
            id="tenor-loading"
            style="display: none; text-align: center; padding: 10px"
          >
            <i class="fa-solid fa-spinner fa-spin"></i> Buscando...
          </div>
          <div id="library-list" class="gif-grid"></div>
          <div
            id="load-more-container"
            style="display: none; text-align: center; margin-top: 10px"
          >
            <button onclick="loadMoreTenor()" class="btn btn-secondary">
              Carregar Mais
            </button>
          </div>
        </div>

        <div class="card">
          <h3>GIFs Locais</h3>
          <div class="gif-grid">
            {% for gif in gifs %}
            <div class="gif-card">
              <img
                src="{{ url_for('serve_pixelart', filename=gif) }}"
                loading="lazy"
              />
              <div class="gif-card-actions">
                <button
                  class="btn-delete"
                  onclick="deleteGif('{{ gif }}')"
                  style="background: none; border: none; cursor: pointer"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              </div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- SISTEMA TAB -->
      <div id="Sistema" class="tab-content">
        <!-- Hardware Card -->
        <div class="card">
          <h3><i class="fa-solid fa-microchip"></i> Hardware</h3>
          <div class="system-grid">
            <div class="stat-item">
              <span class="label">CPU Temp</span>
              <span class="value"
                ><span id="sys-cpu">{{ cpu_temp }}</span>°C</span
              >
            </div>
            <div class="stat-item">
              <span class="label">RAM</span>
              <span class="value"
                ><span id="sys-ram">{{ ram_usage }}</span>%</span
              >
            </div>
            <div class="stat-item">
              <span class="label">Load</span>
              <span class="value"
                ><span id="sys-load">{{ cpu_load }}</span></span
              >
            </div>
            <div class="stat-item">
              <span class="label">Uptime</span>
              <span class="value small" id="sys-uptime">{{ uptime }}</span>
            </div>
          </div>
        </div>

        <!-- Rede Card -->
        <div class="card">
          <h3><i class="fa-solid fa-wifi"></i> Rede</h3>
          <div class="network-info">
            <div class="net-row">
              <div class="net-detail">
                <span class="label">IP Local</span>
                <span class="value" id="sys-ip">{{ ip }}</span>
              </div>
              <div class="net-detail">
                <span class="label">Wi-Fi</span>
                <span class="value" id="sys-wifi">{{ wifi_ssid }}</span>
              </div>
            </div>
            <div class="net-speed-row">
              <div class="speed-item">
                <i class="fa-solid fa-stopwatch"></i> Ping:
                <span id="net-ping">--</span>
              </div>
              <div class="speed-item">
                <i class="fa-solid fa-download"></i> DL:
                <span id="net-download">--</span>
              </div>
            </div>
          </div>
        </div>

        <!-- Armazenamento Card -->
        <div class="card">
          <h3>
            <i class="fa-solid fa-hard-drive"></i> Armazenamento ({{ disk_total
            }}GB)
          </h3>
          <div class="progress-container">
            <div class="progress-bar">
              {% for item in disk_breakdown %}
              <div
                class="progress-fill"
                style="width: {{ item.percent }}%; background-color: {{ item.color }}"
                title="{{ item.name }}: {{ item.size_fmt }}"
              ></div>
              {% endfor %}
            </div>
            <div class="progress-labels">
              {% for item in disk_breakdown %}
              <span style="color: {{ item.color }}">
                <i class="fa-solid fa-folder"></i> {{ item.name }} ({{
                item.size_fmt }})
              </span>
              {% endfor %}
              <span>{{ disk_free }}GB Livre</span>
            </div>
          </div>
        </div>

        <!-- Ações Card -->
        <div class="card">
          <h3><i class="fa-solid fa-sliders"></i> Gerenciamento</h3>
          <div class="actions-grid">
            <button onclick="openLogs()" class="btn btn-secondary">
              <i class="fa-solid fa-terminal"></i> Logs
            </button>
            <button
              class="btn btn-danger"
              onclick="confirmShutdown('/desligar')"
            >
              <i class="fa-solid fa-power-off"></i> Desligar
            </button>
            <button
              class="btn btn-warning"
              onclick="confirmAction('/reiniciar', 'Reiniciar o painel?')"
            >
              <i class="fa-solid fa-rotate-right"></i> Reiniciar
            </button>
          </div>
        </div>
      </div>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Logs do Sistema</h2>
        <pre id="log-output">Carregando...</pre>
        <button onclick="fetchLogs()" class="btn btn-secondary">
          Atualizar
        </button>
      </div>
    </div>

    <!-- Modal de Confirmação Genérica -->
    <div id="confirmModal" class="modal">
      <div class="modal-content modal-sm">
        <h3 id="confirmTitle">Confirmação</h3>
        <p id="confirmMessage">Tem certeza?</p>
        <div id="confirmInputContainer" style="display: none; margin: 15px 0">
          <input
            type="text"
            id="confirmInput"
            style="text-align: center; text-transform: uppercase"
            autocomplete="off"
          />
        </div>
        <div class="modal-actions">
          <button class="btn btn-secondary" onclick="closeConfirmModal()">
            Cancelar
          </button>
          <button
            class="btn btn-danger"
            id="confirmBtnAction"
            onclick="executeConfirm()"
          >
            Confirmar
          </button>
        </div>
      </div>
    </div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>

    <!-- Injeta mensagens flash do servidor como toasts -->
    <script>
      const flashMessages = {{ get_flashed_messages(with_categories=true) | tojson }};
      if (flashMessages && flashMessages.length > 0) {
        flashMessages.forEach(msg => showToast(msg[1], msg[0]));
      }
    </script>
  </body>
</html>
