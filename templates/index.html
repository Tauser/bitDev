<!doctype html>
<html lang="pt-br">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>BITDEV Monitor</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <link
      rel="stylesheet"
      href="{{ url_for('static', filename='style.css') }}?v=2.0"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  </head>
  <body>
    {% macro flash_messages(categories) %} {% with messages =
    get_flashed_messages(with_categories=true, category_filter=categories) %} {%
    if messages %}
    <div class="flash-container" style="margin-bottom: 15px">
      {% for category, message in messages %}
      <div
        class="flash-msg {% if 'error' in category %}flash-error{% else %}flash-success{% endif %}"
      >
        <i
          class="fa-solid {% if 'error' in category %}fa-circle-exclamation{% else %}fa-circle-check{% endif %}"
        ></i>
        <span style="flex: 1">{{ message }}</span>
        <i
          class="fa-solid fa-xmark close-btn"
          onclick="this.parentElement.remove()"
        ></i>
      </div>
      {% endfor %}
    </div>
    {% endif %} {% endwith %} {% endmacro %}

    <div class="container">
      <header>
        <h1><i class="fa-brands fa-bitcoin"></i> BITDEV</h1>
        <div class="subtitle">Painel de Controle do Monitor</div>
      </header>

      <div class="global-actions">
        <a
          href="/reiniciar"
          class="btn btn-restart"
          style="
            margin: 0;
            border-color: var(--warning-color);
            color: var(--warning-color);
          "
          onclick="return confirm('Reiniciar o serviço do painel?');"
        >
          <i class="fa-solid fa-rotate"></i> Reiniciar
        </a>
        <a
          href="/desligar"
          class="btn btn-restart"
          style="
            margin: 0;
            border-color: var(--danger-color);
            color: var(--danger-color);
          "
          onclick="
            return confirm(
              'Tem certeza? Isso desligará o Raspberry Pi completamente.',
            );
          "
        >
          <i class="fa-solid fa-power-off"></i> Desligar
        </a>
      </div>

      {{ flash_messages(['success', 'error', 'info', 'warning']) }}

      <div class="tabs">
        <button class="tab-btn active" onclick="openTab(event, 'tab-controle')">
          <i class="fa-solid fa-sliders"></i> Controle
        </button>
        <button class="tab-btn" onclick="openTab(event, 'tab-conteudo')">
          <i class="fa-solid fa-layer-group"></i> Conteúdo
        </button>
        <button class="tab-btn" onclick="openTab(event, 'tab-sistema')">
          <i class="fa-solid fa-microchip"></i> Sistema
        </button>
      </div>

      <div id="tab-controle" class="tab-content active">
        {{ flash_messages(['control_success', 'control_error']) }}

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-sun"></i> Brilho da Tela
          </div>
          <form action="/brilho" method="POST">
            <div
              style="
                display: flex;
                justify-content: space-between;
                margin-bottom: 10px;
                font-size: 0.9rem;
                color: var(--text-secondary);
              "
            >
              <span>Escuro</span>
              <span style="color: var(--accent-color); font-weight: bold"
                >{{ brilho }}%</span
              >
              <span>Claro</span>
            </div>
            <input
              type="range"
              name="nivel"
              min="10"
              max="100"
              value="{{ brilho }}"
              onchange="this.form.submit()"
            />
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-comment-dots"></i> Letreiro (Rodapé)
          </div>
          <form
            action="/salvar_msg"
            method="POST"
            style="display: flex; gap: 10px"
          >
            <input
              type="text"
              name="msg"
              class="input-text"
              placeholder="Digite uma mensagem (Deixe vazio para voltar ao normal)"
              value="{{ msg_custom }}"
            />
            <button type="submit" class="btn btn-primary" style="width: auto">
              <i class="fa-solid fa-check"></i>
            </button>
            {% if msg_custom %}
            <a href="/limpar_msg" class="btn btn-danger" style="width: auto">
              <i class="fa-solid fa-trash"></i>
            </a>
            {% endif %}
          </form>
        </div>

        <a
          href="/alternar_noturno"
          class="btn btn-secondary"
          style="justify-content: space-between"
        >
          <span
            ><i class="fa-solid fa-moon"></i> Modo Noturno (Tela Apagada)</span
          >
          <span
            style="
              font-size: 0.8rem;
              background: rgba(255, 255, 255, 0.1);
              padding: 2px 8px;
              border-radius: 4px;
            "
          >
            {{ 'ATIVADO' if noturno else 'DESATIVADO' }}
          </span>
        </a>
      </div>

      <div id="tab-conteudo" class="tab-content">
        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-coins"></i> Moedas Monitoradas
          </div>

          {{ flash_messages(['coin_success', 'coin_error']) }}

          <div class="coin-container" id="coin-list">
            {% for moeda in moedas %}
            <div class="coin-chip" data-symbol="{{ moeda }}">
              {{ moeda }}
              <a href="/remover/{{ moeda }}" title="Remover"
                ><i class="fa-solid fa-xmark"></i
              ></a>
            </div>
            {% endfor %}
          </div>

          <form action="/adicionar" method="POST" class="add-coin-form">
            <input
              type="text"
              name="simbolo"
              class="input-text"
              placeholder="Ex: SOL, ADA"
              required
              autocomplete="off"
            />
            <button type="submit" class="btn btn-secondary" style="width: auto">
              <i class="fa-solid fa-plus"></i>
            </button>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-layer-group"></i> Gerenciar Telas
          </div>

          {{ flash_messages(['playlist_success', 'playlist_error']) }}

          <form action="/salvar_playlist" method="POST">
            {% for page in pages %}
            <div class="page-row">
              <div class="switch-wrapper">
                <label class="toggle-switch">
                  <input
                    type="checkbox"
                    name="enable_{{ page.id }}"
                    {%
                    if
                    page.enabled
                    %}checked{%
                    endif
                    %}
                  />
                  <span class="slider"></span>
                </label>
                <span style="font-weight: 500">{{ page.nome }}</span>
              </div>

              <div class="time-input-group">
                <i
                  class="fa-regular fa-clock"
                  style="font-size: 0.8rem; color: #64748b"
                ></i>
                <input
                  type="number"
                  name="time_{{ page.id }}"
                  value="{{ page.tempo }}"
                  min="5"
                />
                <span>s</span>
              </div>
            </div>
            {% endfor %}
            <button
              type="submit"
              class="btn btn-primary"
              style="margin-top: 15px"
            >
              <i class="fa-solid fa-save"></i> Salvar Alterações
            </button>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-image"></i> Gerenciar Galeria
          </div>

          {{ flash_messages(['gallery_success', 'gallery_error']) }}

          <form
            action="/upload_gif"
            method="POST"
            enctype="multipart/form-data"
            style="display: flex; gap: 10px; align-items: center"
          >
            <input
              type="file"
              name="file"
              accept=".gif"
              style="color: var(--text-secondary); font-size: 0.9rem"
              required
            />
            <button type="submit" class="btn btn-primary" style="width: auto">
              <i class="fa-solid fa-cloud-arrow-up"></i> Enviar
            </button>
          </form>

          <form
            action="/download_gif"
            method="POST"
            style="
              display: flex;
              gap: 10px;
              align-items: center;
              margin-top: 10px;
            "
          >
            <input
              type="text"
              name="url"
              class="input-text"
              placeholder="Ou cole a URL de um GIF..."
              required
            />
            <input
              type="text"
              name="name"
              class="input-text"
              placeholder="Nome"
              style="width: 30%"
              required
            />
            <button type="submit" class="btn btn-secondary" style="width: auto">
              <i class="fa-solid fa-cloud-arrow-down"></i>
            </button>
          </form>

          {% if gifs %}
          <div class="gif-gallery">
            {% for gif in gifs %}
            <div class="gif-card">
              <img src="/pixelart/{{ gif }}" loading="lazy" />
              <div class="gif-card-actions">
                <a
                  href="/delete_gif/{{ gif }}"
                  style="color: var(--danger-color); text-decoration: none"
                >
                  <i class="fa-solid fa-trash"></i>
                </a>
              </div>
            </div>
            {% endfor %}
          </div>
          {% else %}
          <div
            style="
              margin-top: 15px;
              color: var(--text-secondary);
              font-size: 0.9rem;
              text-align: center;
            "
          >
            Nenhum GIF na galeria.
          </div>
          {% endif %}

          <div
            style="
              margin-top: 20px;
              border-top: 1px solid rgba(255, 255, 255, 0.1);
              padding-top: 15px;
            "
          >
            <div
              style="
                font-size: 0.9rem;
                color: var(--text-secondary);
                margin-bottom: 10px;
              "
            >
              <i class="fa-solid fa-globe"></i> Buscar na Internet (Tenor)
            </div>

            <div
              style="
                display: flex;
                flex-direction: column;
                gap: 10px;
                margin-bottom: 15px;
              "
            >
              <div style="display: flex; gap: 10px">
                <input
                  type="text"
                  id="tenor-query"
                  class="input-text"
                  placeholder="Ex: Mario, Space, Cyberpunk..."
                  onkeypress="handleEnter(event)"
                />
                <button
                  class="btn btn-primary"
                  style="width: auto"
                  onclick="searchTenor()"
                >
                  <i class="fa-solid fa-magnifying-glass"></i>
                </button>
              </div>
            </div>

            <div
              id="tenor-loading"
              style="
                display: none;
                text-align: center;
                color: var(--text-secondary);
                margin: 10px;
              "
            >
              <i class="fa-solid fa-circle-notch fa-spin"></i> Buscando...
            </div>

            <div class="gif-gallery" id="library-list"></div>

            <div
              id="load-more-container"
              style="text-align: center; margin-top: 15px; display: none"
            >
              <button
                class="btn btn-secondary"
                onclick="loadMoreTenor()"
                style="width: auto"
              >
                Carregar Mais <i class="fa-solid fa-chevron-down"></i>
              </button>
            </div>
          </div>
        </div>
      </div>

      <div id="tab-sistema" class="tab-content">
        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-server"></i> Status do Sistema
          </div>
          <div class="info-grid">
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-clock"></i> Uptime</span
              >
              <span class="info-value">{{ uptime }}</span>
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-temperature-half"></i> CPU Temp</span
              >
              <span class="info-value" style="color: {{ cpu_color }};">
                {{ cpu_temp }}°C
              </span>
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-sd-card"></i> Disco ({{ disk_percent
                }}%)</span
              >
              <div
                class="disk-progress-track"
                style="width: 100%; margin: 5px 0"
              >
                <div
                  class="disk-progress-fill"
                  style="width: {{ disk_percent }}%; background: {{ disk_color }};"
                ></div>
              </div>
              <span style="font-size: 0.8rem; color: var(--text-secondary)">
                {{ disk_free }}GB livres
              </span>
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-memory"></i> RAM ({{ ram_percent
                }}%)</span
              >
              <div
                class="disk-progress-track"
                style="width: 100%; margin: 5px 0"
              >
                <div
                  class="disk-progress-fill"
                  style="width: {{ ram_percent }}%; background: {{ ram_color }};"
                ></div>
              </div>
              <span style="font-size: 0.8rem; color: var(--text-secondary)">
                {{ ram_total }}MB Total
              </span>
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-gauge-high"></i> CPU Load</span
              >
              <span class="info-value">{{ load_1m }}</span>
              <span
                style="
                  font-size: 0.7rem;
                  display: block;
                  color: var(--text-secondary);
                "
                >Média 1 min</span
              >
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-wifi"></i> Wi-Fi</span
              >
              <span class="info-value" style="color: {{ wifi_color }};">
                {{ wifi_percent }}%
              </span>
              <span
                style="
                  font-size: 0.7rem;
                  display: block;
                  color: var(--text-secondary);
                "
                >Sinal</span
              >
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-network-wired"></i> IP Local</span
              >
              <span class="info-value" style="font-size: 0.9rem"
                >{{ local_ip }}</span
              >
              <span
                style="
                  font-size: 0.7rem;
                  display: block;
                  color: var(--text-secondary);
                "
                >Rede</span
              >
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-stopwatch"></i> Ping</span
              >
              <span class="info-value" id="net-ping"
                ><i
                  class="fa-solid fa-circle-notch fa-spin"
                  style="font-size: 0.8rem"
                ></i
              ></span>
              <span
                style="
                  font-size: 0.7rem;
                  display: block;
                  color: var(--text-secondary);
                "
                >Latência</span
              >
            </div>
            <div class="info-item">
              <span class="info-label"
                ><i class="fa-solid fa-download"></i> Download</span
              >
              <span class="info-value" id="net-download"
                ><i
                  class="fa-solid fa-circle-notch fa-spin"
                  style="font-size: 0.8rem"
                ></i
              ></span>
              <span
                style="
                  font-size: 0.7rem;
                  display: block;
                  color: var(--text-secondary);
                "
                >Estimado</span
              >
            </div>

            <div
              class="info-item"
              style="
                grid-column: 1 / -1;
                height: 280px;
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
              "
            >
              <span class="info-label" style="margin-bottom: 10px"
                ><i class="fa-solid fa-chart-pie"></i> Distribuição de Disco
                (GB)</span
              >
              <div style="position: relative; width: 100%; height: 100%">
                <canvas
                  id="diskChart"
                  data-free="{{ disk_free }}"
                  data-total="{{ disk_total }}"
                ></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-wifi"></i> Configuração de Rede
          </div>

          {{ flash_messages(['wifi_success', 'wifi_error']) }}

          <form
            action="/salvar_wifi"
            method="POST"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <input
              type="text"
              name="ssid"
              class="input-text"
              placeholder="Nome da Rede (SSID)"
              required
            />
            <input
              type="password"
              name="psk"
              class="input-text"
              placeholder="Senha do Wi-Fi"
              required
            />
            <div style="display: flex; gap: 10px">
              <button type="submit" class="btn btn-primary">
                <i class="fa-solid fa-save"></i> Salvar e Conectar
              </button>
              <a
                href="/wifi_reset"
                class="btn btn-secondary"
                style="width: auto"
                title="Forçar Reconexão"
                ><i class="fa-solid fa-rotate"></i
              ></a>
            </div>
          </form>
        </div>

        <div class="card">
          <div class="card-header">
            <i class="fa-solid fa-cube"></i> Configuração Klipper (Voron)
          </div>

          {{ flash_messages(['printer_success', 'printer_error']) }}

          <form
            action="/salvar_printer"
            method="POST"
            style="display: flex; flex-direction: column; gap: 10px"
          >
            <input
              type="text"
              name="printer_name"
              class="input-text"
              placeholder="Nome (Ex: VORON 2.4)"
              value="{{ printer_name }}"
            />
            <input
              type="text"
              name="printer_ip"
              class="input-text"
              placeholder="IP da Impressora (Ex: 192.168.1.50)"
              value="{{ printer_ip }}"
              required
            />
            <button type="submit" class="btn btn-primary">
              <i class="fa-solid fa-save"></i>
            </button>
          </form>
        </div>

        <div style="display: grid; grid-template-columns: 1fr; gap: 10px">
          <a
            href="/atualizar"
            class="btn btn-primary"
            onclick="
              return confirm(
                'Deseja buscar atualizações no GitHub e reiniciar o sistema?',
              );
            "
          >
            <i class="fa-solid fa-cloud-arrow-down"></i> Atualizar Versão
          </a>

          <a
            href="#"
            class="btn btn-secondary"
            onclick="
              openLogs();
              return false;
            "
          >
            <i class="fa-solid fa-terminal"></i> Ver Logs do Sistema
          </a>
        </div>
      </div>

      <footer
        style="
          text-align: center;
          margin-top: 30px;
          color: var(--text-secondary);
          font-size: 0.8rem;
          opacity: 0.8;
        "
      >
        &copy; 2026 BITDEV Monitor by Tauser. Todos os direitos reservados.
      </footer>
    </div>

    <div id="logModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2><i class="fa-solid fa-terminal"></i> Logs do Sistema</h2>
          <span class="close-modal" onclick="closeModal()">&times;</span>
        </div>
        <div class="modal-body">
          <pre id="log-output">Carregando...</pre>
        </div>
        <div class="modal-footer">
          <button
            class="btn btn-secondary"
            onclick="fetchLogs()"
            style="width: auto"
          >
            <i class="fa-solid fa-rotate"></i> Atualizar
          </button>
          <button
            class="btn btn-primary"
            onclick="closeModal()"
            style="width: auto"
          >
            Fechar
          </button>
        </div>
      </div>
    </div>

    <script
      src="{{ url_for('static', filename='script.js') }}?v=2.0"
      defer
    ></script>
  </body>
</html>
